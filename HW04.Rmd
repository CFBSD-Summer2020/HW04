---
title: "Exploring Gun Deaths in America"
author: "Ricardo Mu√±iz Trejo"
output: github_document
---

## Objectives
* To explore gun death data curated by FiveThirtyEight [original data available here](https://github.com/fivethirtyeight/guns-data) by
    * Month
    * Intent
    * Age and sex
    * Education
    * Season
    * Intent by race
    * Police-relatedness 

## Read in the data

The gun_deaths.csv is provided in the repository. 
```{r load-data, message=FALSE, warning=FALSE}
library(tidyverse)    # load tidyverse packages, including ggplot2
library(knitr)
library(ggsignif) #This package adds significance bars to plots, useful for the last exercise
theme_set(theme_bw())

# read in the data
guns <-read.csv("gun_deaths.csv")

str(guns)

```

## Generating a data frame that summarizes the number of gun deaths per month and printing using `kable()`. 

Knitr is part of the knitr package. Allows you to change column names and add captions and make pretty tables in your knitted document. Hint: set the argument format = "markdown"


```{r month, warning=FALSE, echo=F}

#Create the data frame for gun deaths per month
deaths_month <- guns %>%
    group_by(month) %>%
    count(month) %>%
    rename(Deaths_per_month = n)

#Turns out R has a predefined object called month.abb that contains the abbreviated month names. This way is easy to change the numbers in the data frame for the actual month name. You only have to change the column type to a leveled factor and voila!
deaths_month$month <- factor(month.abb[deaths_month$month], levels = month.abb, ordered = TRUE)


kable(deaths_month, format = "markdown", col.names = c("Month", "Deaths per month"))

```


### Generating a bar chart with human-readable labels on the x-axis. That is, each month should be labeled "Jan", "Feb", "Mar" (full or abbreviated month names are fine), not `1`, `2`, `3`.

```{r month_chart, echo=F}

#Since deaths_month$month was already a leveled fector with abbreviated month names (line 43), you only need to graph.
#The instruction was for the total number of deaths per month, not per year, but the data frame contains observations from 2012 to 2014.

deaths_month %>%
    ggplot(aes(x = month, y = Deaths_per_month)) + 
    geom_col(fill = "blue") + #Filled just to pop some color there, I don't like grey
        labs(title = "Number of gun deaths per month from 2012-2014",
         x = "Month",
         y = "Number of gun deaths",
         caption = "Source: fivethirtyeight.com")
```

## Generating a bar chart that identifies the number of gun deaths associated with each type of intent cause of death. The bars should be sorted from highest to lowest values.

```{r intent, echo=F}

deaths_intent <- guns %>%
    group_by(intent) %>%
    count(intent, sort = TRUE) %>% #Sorted values from highest to lowest
    rename(no_of_deaths = n)


kable(deaths_intent, format = "markdown", col.names = c("Intent", "No. of deaths"))

#Just to order the intent from highest to lowest
deaths_intent$intent_ordered <- deaths_intent$intent
deaths_intent$intent <- factor(deaths_intent$intent, levels = deaths_intent$intent_ordered, ordered = TRUE)


ggplot(deaths_intent, aes(x = intent, y = no_of_deaths)) +
    geom_col(fill = "red") + 
    labs(title = "Number of gun deaths associated with each type of \nintent cause of death from 2012-2014",
         x = "Intent cause of death",
         y = "Number of gun deaths",
         caption = "Source: fivethirtyeight.com")


```

## Generating a boxplot visualizing the age of gun death victims, by sex. Print the average age of female gun death victims.

```{r age_&_sex, echo=F}

#This way we can clean our data from Not Available age values, and even though is not necessary, I prefer to work with a smaller data set hence the select() function
death_sex_age <- guns %>%
    select(sex, age) %>%
    filter(age != "Not Available")

#We need to change the column type from "character" to "integer" to create the boxplot
death_sex_age$age <- as.integer(death_sex_age$age)

death_sex_age %>%
    ggplot(aes(x = sex, y = age, fill = sex), alpha = 0.5) +
    geom_boxplot() +
    labs(title = "Age distibution of gun death victims by sex",
         x = "Sex",
         y = "Age",
         caption = "Source: fivethirtyeight.com")

#We only need data from females, so we can filter it
avg_fem_deaths <- death_sex_age %>%
    filter(sex == "F") 

print(paste("The average age of female gun death victims is", round(mean(avg_fem_deaths$age)), "years"))



```


## How many white males with at least a high school education were killed by guns in 2012?

```{r education, echo=F}

deaths_WM_HS_2012 <- guns %>%
    select(year, sex, race, education) %>%
    filter(year == 2012, race == "White", education != "Less than HS") %>%
    count(sex = "M")

print(paste(deaths_WM_HS_2012$n, "white males with at least high school education were killed by guns in 2012"))

    
```


## Which season of the year has the most gun deaths?

Assume that:

* Winter = January-March
* Spring = April-June
* Summer = July-September
* Fall = October-December

```{r season, echo=F}

#We need to add a new column to the deaths_month vector (line 38) with the corresponding season
deaths_month$season[deaths_month$month %in% c("Jan", "Feb", "Mar")] <- "Winter"
deaths_month$season[deaths_month$month %in% c("Apr", "May", "Jun")] <- "Spring"
deaths_month$season[deaths_month$month %in% c("Jul", "Aug", "Sep")] <- "Summer"
deaths_month$season[deaths_month$month %in% c("Oct", "Nov", "Dec")] <- "Fall"

most_death_season <- deaths_month %>%
    group_by(season) %>%
    summarize(total_deaths = sum(Deaths_per_month)) %>%
    top_n(1, total_deaths)

print(paste("The season with most gun deaths is", most_death_season$season, "with", most_death_season$total_deaths, "deaths in total from 2012-2014"))

```


# These are more open ended questions from here on out, you could look at making multiple summaries or types of plots. 

### Are whites who are killed by guns more likely to die because of suicide or homicide? How does this compare to blacks and hispanics?

**Answer**
Looking at the gross numbers, some general trends start to arise. It is clear by the data that white people gun deaths are more related to suicide than homicide. On the other hand, black people gun deaths are the opposite, with more deaths related to homicide than suicide. Meanwhile, hispanic population seems about the same.

```{r race, echo=F}

deaths_race <- guns %>%
    group_by(race, intent) %>%
    filter(intent %in% c("Homicide", "Suicide"), 
           race %in% c("White", "Hispanic", "Black")) %>%
    count(race) %>%
    rename(deaths = n) %>%
    ungroup() #It is important to ungroup to perform further analysis

#A simple graph comparing the total number of gun deaths per race and intent.
deaths_race %>%
    ggplot(aes(x = race, y = deaths, fill = intent)) +
    geom_col(position = "dodge") +
    labs(title = "Total number of gun deaths per race and intent from 2012-2014",
         x = "Race",
         y = "Number of gun deaths",
         caption = "Source: fivethirtyeight.com")

```

**Answer (continuation)**
When analyzing percentages per race, it is worth noting that the percentage of black people killed by homicide is around the same as white people that committed suicide (85%). This means that white people is as likely to die from suicide than black people is to die from homicide. For the hispanic population, the likeliness of dying because of homicide is 20% lower than black people, but it remains as the most likely cause of gun death.


(hint maybe looking at percentages would be good)
```{r race_2, echo=F}

#If there's better way of doing the following I don't know how.
#I decomposed the deaths_race data frame into races to calculate the percentages of gun deaths by intent individually.
black_percent <- deaths_race %>%
    filter(race == "Black") %>%
    mutate(percentage = round(deaths / sum(deaths)* 100, digits = 2))

hispanic_percent <- deaths_race %>%
    filter(race == "Hispanic") %>%
    mutate(percentage = round(deaths / sum(deaths)* 100, digits = 2))

white_percent <- deaths_race %>%
    filter(race == "White") %>%
    mutate(percentage = round(deaths / sum(deaths)* 100, digits = 2))

#Then I merged the data frames per race to gain a new data frame that can be used to make a graph
deaths_race_percentage <- rbind(black_percent, hispanic_percent, white_percent)

#I initially did this as pie charts, since the percentages allow it, but I kinda like this visualization better, it's much more comparable in my opinion. 
deaths_race_percentage %>%
    ggplot(aes(x = race, y = percentage, fill = intent)) +
    geom_col() +
    labs(title = "Percentage of gun deaths per race and intent from 2012-2014",
         x = "Race",
         y = "Percentage (%)",
         caption = "Source: fivethirtyeight.com") 

#Finally, a table with the exact data never does harm
kable(deaths_race_percentage, format = "markdown", col.names = c("Race", "Intent", "Total deaths", "Percentage per race"))

```


### Are police-involved gun deaths significantly different from other gun deaths? Assess the relationship between police involvement and age, police involvement and race, and the intersection of all three variables.

```{r police}
deaths_police_age <- guns %>%
    select(police, age) %>%
    filter(age != "Not Available")


deaths_police_age$age <- as.integer(deaths_police_age$age)
deaths_police_age$police <- factor(deaths_police_age$police, levels = c(0, 1), ordered = TRUE)


deaths_police_age %>%
    ggplot(aes(x = police, y = age, fill = police)) +
    geom_violin(alpha = 0.5) +
    geom_boxplot(width = 0.05)

deaths_police_race <- guns %>%
    select(police, race) %>%
    group_by(police) %>%
    count(race)

deaths_police_race$police <- factor(deaths_police_race$police, levels = c(0, 1), ordered = TRUE)

deaths_police_race %>%
    ggplot(aes(x = race, y = n, fill = police)) +
    geom_col(position = "dodge") +
    scale_y_log10()



#involvement <- c("Not involved", "Involved")
#deaths_police$police <- factor(deaths_police$police, levels = c(0, 1), ordered = TRUE)

#deaths_police %>%
#    ggplot(aes(x = police, y = age, fill = police)) +
#    geom_violin(alpha = 0.5) +
#    geom_boxplot(width = 0.05)


```

Think about performing stats such as a t.test to see if differences you are plotting are statistically significant

```{r stats?}

test_pol_age <- t.test(deaths_police_age$age[deaths_police_age$police == 0],
                       deaths_police_age$age[deaths_police_age$police == 1])

test_pol_age
```


```{r police_2}

```

```{r stats_2?}


```


Finally, all together now:
```{r police_3}

```


## Session info

```{r}
# always good to have this for reproducibility purposes
devtools::session_info()
```

